@page "/"
@inject IOpenAIService OpenAIService

<div class="flex flex-col h-full bg-backdrop text-brightWhite relative">
    <ChatMessages
        Chats="chats" ErrorMessage="@errorMessage" OnImageClick="OpenModal" OnError="HandleError"
    />
    <ChatInput
        UserMessage="@userMessage"
        IsSending="@isSending"
        IsGeneratingImage="@isGeneratingImage"
        OnSendMessage="HandleSendMessage"
        OnToggleImageGeneration="HandleToggleImageGeneration"
        OnClearMessages="HandleClearMessages"
        OnError="HandleError"
    />
    @if (showModal)
    {
        <Modal
            ImageSrc="@selectedImage"
            OnClose="HandleModalClose"
            OnError="HandleError"
        />
    }
</div>

@code {
    private string userMessage = "";
    private bool isSending = false;
    private bool isGeneratingImage = false;
    private List<ChatMessageModel> chats = new List<ChatMessageModel>();
    private List<ChatMessageModel> conversation = new List<ChatMessageModel>();
    private bool showModal = false;
    private string selectedImage = "";
    private string errorMessage = ""; // Initialize as an empty string

    private async Task HandleSendMessage(string message)
    {
        if (string.IsNullOrWhiteSpace(message))
        {
            return;
        }

        var tempUserMessage = message;
        userMessage = string.Empty; // Clear the input field
        isSending = true;
        StateHasChanged();

        var userChatMessage = new ChatMessageModel(tempUserMessage, "user");
        chats.Add(userChatMessage); // Add user message to chats
        conversation.Add(userChatMessage); // Keep the full conversation context

        try
        {
            if (isGeneratingImage)
            {
                var loadingMessage = new ChatMessageModel("", "assistant", true, true);
                chats.Add(loadingMessage);
                StateHasChanged();

                await OpenAIService.GenerateImageAsync(tempUserMessage, (imageBytes) =>
                {
                    try
                    {
                        UpdateImageResponse(imageBytes, loadingMessage);
                    }
                    catch (Exception ex)
                    {
                        RemoveLoadingMessage(loadingMessage);
                        UpdateErrorResponse($"Error updating image response: {ex.Message}");
                    }
                }, (error) =>
                {
                    RemoveLoadingMessage(loadingMessage);
                    UpdateErrorResponse(error);
                });
            }
            else
            {
                await OpenAIService.GetChatCompletionStreamingAsync(conversation.Where(c => !c.IsImage).ToList(), tempUserMessage, (update) =>
                {
                    try
                    {
                        UpdateResponse(update);
                    }
                    catch (Exception ex)
                    {
                        UpdateErrorResponse($"Error updating chat response: {ex.Message}");
                    }
                });
            }
        }
        catch (Exception ex)
        {
            HandleError($"Error sending message: {ex.Message}");
        }
        finally
        {
            isSending = false;
            StateHasChanged();
        }
    }

    private void HandleToggleImageGeneration(bool isGenerating)
    {
        try
        {
            isGeneratingImage = isGenerating;
        }
        catch (Exception ex)
        {
            HandleError($"Error toggling image generation: {ex.Message}");
        }
    }

    private void HandleClearMessages()
    {
        try
        {
            chats.Clear();
            conversation.Clear();
            errorMessage = ""; // Clear error message
            StateHasChanged();
        }
        catch (Exception ex)
        {
            HandleError($"Error clearing messages: {ex.Message}");
        }
    }

    private void HandleError(string message)
    {
        errorMessage = message;
        StateHasChanged();
    }

    private void OpenModal(string imageSrc)
    {
        try
        {
            selectedImage = imageSrc;
            showModal = true;
        }
        catch (Exception ex)
        {
            HandleError($"Error opening modal: {ex.Message}");
        }
    }

    private void HandleModalClose()
    {
        try
        {
            showModal = false;
        }
        catch (Exception ex)
        {
            HandleError($"Error closing modal: {ex.Message}");
        }
    }

    private void UpdateResponse(string update)
    {
        try
        {
            if (chats.LastOrDefault()?.Role == "assistant")
            {
                chats.Last().Message += update;
            }
            else
            {
                var newMessage = new ChatMessageModel(update, "assistant");
                chats.Add(newMessage);
                conversation.Add(newMessage);
            }
            InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            HandleError($"Error updating response: {ex.Message}");
        }
    }

    private void UpdateImageResponse(byte[] imageBytes, ChatMessageModel loadingMessage)
    {
        try
        {
            var base64Image = Convert.ToBase64String(imageBytes);
            loadingMessage.Message = base64Image;
            loadingMessage.IsLoading = false;
            conversation.Add(loadingMessage);
            InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            HandleError($"Error updating image response: {ex.Message}");
        }
    }

    private void UpdateErrorResponse(string error)
    {
        try
        {
            var errorMessageModel = new ChatMessageModel(error, "error"); // Set error message role to "error"
            errorMessage = error; // Set error message
            chats.Add(errorMessageModel);
            conversation.Add(errorMessageModel);
            InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            HandleError($"Error updating error response: {ex.Message}");
        }
    }

    private void RemoveLoadingMessage(ChatMessageModel loadingMessage)
    {
        if (chats.Contains(loadingMessage))
        {
            chats.Remove(loadingMessage);
        }
        InvokeAsync(StateHasChanged);
    }
}
