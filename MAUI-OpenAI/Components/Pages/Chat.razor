@page "/"
@inject IOpenAIService OpenAIService
@inject IMarkdownService MarkdownService

<div class="flex flex-col h-full bg-backdrop text-brightWhite relative">
    <RoleSelector
        IsImageLoading="@isImageLoading"
        IsSending="@isSending"
        OnRoleSelected="HandleRoleSelected"
        OnImageGenerated="HandleImageGenerated"
        OnError="HandleError"
        OnLoading="HandleLoading"
    />
    <ChatMessages
        ChatMessageList="chatMessages"
        ErrorMessage="@errorMessage"
        OnImageClick="OpenModal"
        OnError="HandleError"
        IsLoading="@isImageLoading"
    />
    <ChatInput
        UserMessage="@userMessage"
        IsSending="@isSending"
        IsGeneratingImage="@isGeneratingImage"
        IsImageLoading="@isImageLoading"
        TokenCount="@tokenCount"
        MaxTokens="@MaxTokens"
        CharactersPerToken="@CharactersPerToken"
        OnSendMessage="HandleSendMessage"
        OnToggleImageGeneration="HandleToggleImageGeneration"
        OnClearMessages="HandleClearMessages"
        OnError="HandleError"
    />
    @if (showModal)
    {
        <Modal
            ImageSrc="@selectedImage"
            OnClose="HandleModalClose"
            OnError="HandleError"
        />
    }
</div>

@code {
    private string userMessage = "";
    private bool isSending = false;
    private bool isGeneratingImage = false;
    private bool isImageLoading = false;
    private bool isMessageReceiving = false;
    private List<ChatMessageModel> chatMessages = new List<ChatMessageModel>();
    private List<ChatMessageModel> conversation = new List<ChatMessageModel>();
    private bool showModal = false;
    private string selectedImage = "";
    private string errorMessage = "";
    private string currentRole = "";

    private const int MaxTokens = 1000;
    private const double CharactersPerToken = 3.5;
    private int tokenCount = 0;

    private async Task HandleSendMessage(string message)
    {
        if (string.IsNullOrWhiteSpace(message)) return;

        PrepareForMessageSend(message);
        AddUserMessage(message);

        try
        {
            if (isGeneratingImage)
            {
                await GenerateImageResponse(message);
            }
            else
            {
                await GenerateChatResponse(message);
            }
        }
        catch (Exception ex)
        {
            HandleError($"Error sending message: {ex.Message}");
        }
        finally
        {
            FinishMessageSend();
        }
    }

    private void PrepareForMessageSend(string message)
    {
        userMessage = string.Empty;
        isSending = true;
        StateHasChanged();
    }

    private void AddUserMessage(string message)
    {
        var userChatMessage = new ChatMessageModel(message, "user");
        chatMessages.Add(userChatMessage);
        conversation.Add(userChatMessage);
    }

    private async Task GenerateImageResponse(string message)
    {
        var loadingMessage = AddLoadingMessage();

        await OpenAIService.GenerateImageAsync(message, (imageBytes) =>
        {
            try
            {
                UpdateImageResponse(imageBytes, loadingMessage);
            }
            catch (Exception ex)
            {
                RemoveLoadingMessage(loadingMessage);
                HandleError($"Error updating image response: {ex.Message}");
            }
        }, (error) =>
        {
            RemoveLoadingMessage(loadingMessage);
            HandleError(error);
        });
    }

    private ChatMessageModel AddLoadingMessage()
    {
        var loadingMessage = new ChatMessageModel("", "assistant", true, true);
        chatMessages.Add(loadingMessage);
        StateHasChanged();
        return loadingMessage;
    }

    private async Task GenerateChatResponse(string message)
    {
        await OpenAIService.GetChatCompletionStreamingAsync(conversation.Where(c => !c.IsImage).ToList(), message, (update) =>
        {
            try
            {
                UpdateResponse(update);
            }
            catch (Exception ex)
            {
                HandleError($"Error updating chat response: {ex.Message}");
            }
        }, () =>
        {
            CompleteResponse(chatMessages.Last());
        });
    }

    private void FinishMessageSend()
    {
        isSending = false;
        StateHasChanged();
    }

    private void CompleteResponse(ChatMessageModel chatMessage)
    {
        try
        {
            chatMessage.HtmlContent = MarkdownService.ConvertToHtml(chatMessage.Message);
            InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            HandleError($"Error completing response: {ex.Message}");
        }
    }

    private async Task HandleRoleSelected(string newRolePrompt)
    {
        AddForgetPreviousRoleMessage();
        AddRoleMessage(newRolePrompt);

        currentRole = newRolePrompt;
        StateHasChanged();
    }

    private void AddForgetPreviousRoleMessage()
    {
        if (!string.IsNullOrEmpty(currentRole))
        {
            var forgetMessage = new ChatMessageModel("Forget the previous role.", "user");
            conversation.Add(forgetMessage);
        }
    }

    private void AddRoleMessage(string newRolePrompt)
    {
        var roleMessage = new ChatMessageModel(newRolePrompt, "system");
        conversation.Add(roleMessage);
    }

    private void HandleImageGenerated(byte[] imageBytes)
    {
        isImageLoading = false;
        AddImageMessage(imageBytes);
        StateHasChanged();
    }

    private void AddImageMessage(byte[] imageBytes)
    {
        var base64Image = Convert.ToBase64String(imageBytes);
        var imageMessage = new ChatMessageModel(base64Image, "assistant", isImage: true);
        chatMessages.Add(imageMessage);
        conversation.Add(imageMessage);
    }

    private async Task HandleLoading(bool isLoading)
    {
        isImageLoading = isLoading;
        await InvokeAsync(StateHasChanged);
    }

    private void HandleToggleImageGeneration(bool isGenerating)
    {
        try
        {
            isGeneratingImage = isGenerating;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            HandleError($"Error toggling image generation: {ex.Message}");
        }
    }

    private void HandleClearMessages()
    {
        try
        {
            ClearAllMessages();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            HandleError($"Error clearing messages: {ex.Message}");
        }
    }

    private void ClearAllMessages()
    {
        chatMessages.Clear();
        conversation.Clear();
        errorMessage = "";
    }

    private void HandleError(string message)
    {
        errorMessage = message;
        StateHasChanged();
    }

    private void OpenModal(string imageSrc)
    {
        try
        {
            selectedImage = imageSrc;
            showModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            HandleError($"Error opening modal: {ex.Message}");
        }
    }

    private void HandleModalClose()
    {
        try
        {
            showModal = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            HandleError($"Error closing modal: {ex.Message}");
        }
    }

    private void UpdateResponse(string update)
    {
        try
        {
            if (chatMessages.LastOrDefault()?.Role == "assistant")
            {
                chatMessages.Last().Message += update;
            }
            else
            {
                AddNewAssistantMessage(update);
            }
            InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            HandleError($"Error updating response: {ex.Message}");
        }
    }

    private void AddNewAssistantMessage(string update)
    {
        var newMessage = new ChatMessageModel(update, "assistant");
        chatMessages.Add(newMessage);
        conversation.Add(newMessage);
    }

    private void UpdateImageResponse(byte[] imageBytes, ChatMessageModel loadingMessage)
    {
        try
        {
            var base64Image = Convert.ToBase64String(imageBytes);
            loadingMessage.Message = base64Image;
            loadingMessage.IsLoading = false;
            conversation.Add(loadingMessage);
            InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            HandleError($"Error updating image response: {ex.Message}");
        }
    }

    private void UpdateErrorResponse(string error)
    {
        try
        {
            AddErrorMessage(error);
            InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            HandleError($"Error updating error response: {ex.Message}");
        }
    }

    private void AddErrorMessage(string error)
    {
        var errorMessageModel = new ChatMessageModel(error, "error");
        errorMessage = error;
        chatMessages.Add(errorMessageModel);
        conversation.Add(errorMessageModel);
    }

    private void RemoveLoadingMessage(ChatMessageModel loadingMessage)
    {
        if (chatMessages.Contains(loadingMessage))
        {
            chatMessages.Remove(loadingMessage);
        }
        InvokeAsync(StateHasChanged);
    }
}