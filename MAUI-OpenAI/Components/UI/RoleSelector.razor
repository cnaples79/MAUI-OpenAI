@using MAUI_OpenAI.Data
@using MAUI_OpenAI.Models

<div class="mb-4 flex gap-4">
    <ComboBox
        IsSendingMessage="@IsSendingMessage"
        IsGeneratingImage="@IsGeneratingImage"
        IsImageLoading="@IsImageLoading"
        Items="RolePrompts.Roles.Keys.ToList()"
        OnItemSelected="HandleRoleChange"
        @ref="comboBoxRef"
    />
    @if (!string.IsNullOrEmpty(selectedRole))
    {
        <GetAppearance
            IsSendingMessage="@IsSendingMessage"
            IsGeneratingImage="@IsGeneratingImage"
            IsImageLoading="@IsImageLoading"
            Role="@selectedRole"
            Description="@RolePrompts.Roles[selectedRole]"
            OnImageGenerated="HandleImageGenerated"
            OnError="HandleError"
            OnLoading="HandleLoading"
            IsAppearanceGenerating="@isAppearanceGenerating"
        />
    }
</div>

@code {
    [Parameter]
    public EventCallback<string> OnRoleSelected { get; set; }
    [Parameter]
    public EventCallback<byte[]> OnImageGenerated { get; set; }
    [Parameter]
    public EventCallback<string> OnError { get; set; }
    [Parameter]
    public EventCallback<bool> OnLoading { get; set; }
    [Parameter]
    public bool IsSendingMessage { get; set; } = false;
    [Parameter]
    public bool IsGeneratingImage { get; set; } = false;
    [Parameter]
    public bool IsImageLoading { get; set; } = false;

    private string selectedRole = "";
    private bool isAppearanceGenerating = false;
    private ComboBox comboBoxRef;

    private async Task HandleRoleChange(string value)
    {
        selectedRole = value;
        if (OnRoleSelected.HasDelegate && RolePrompts.Roles.TryGetValue(selectedRole, out var prompt))
        {
            await OnRoleSelected.InvokeAsync(prompt);
        }
    }

    private async Task HandleImageGenerated(byte[] imageBytes)
    {
        isAppearanceGenerating = false;
        if (OnImageGenerated.HasDelegate)
        {
            await OnImageGenerated.InvokeAsync(imageBytes);
        }
    }

    private async Task HandleError(string error)
    {
        isAppearanceGenerating = false;
        if (OnError.HasDelegate)
        {
            await OnError.InvokeAsync(error);
        }
    }

    private async Task HandleLoading(bool loading)
    {
        isAppearanceGenerating = loading;
        if (OnLoading.HasDelegate)
        {
            await OnLoading.InvokeAsync(loading);
        }
    }

    public async Task ClearRoleAsync()
    {
        selectedRole = "";
        if (comboBoxRef != null)
        {
            await comboBoxRef.ClearAsync();
        }
        StateHasChanged();
    }
}